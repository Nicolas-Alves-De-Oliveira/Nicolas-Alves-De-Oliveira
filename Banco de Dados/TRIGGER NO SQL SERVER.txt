/* TRIGGER NO SQL SERVER */

CREATE TABLE PRODUTOS(
          IDPRODUTO INT PRIMARY KEY IDENTITY,
          NOME VARCHAR(50) NOT NULL,
          CATEGORIA VARCHAR(30) NOT NULL,
          PRECO NUMERIC(10,2) NOT NULL
)
GO

CREATE TABLE HISTORICO(
           IDOPERACAO INT PRIMARY KEY IDENTITY,
           PRODUTO VARCHAR(50) NOT NULL,
           CATEGORIA VARCHAR(30) NOT NULL,
           PRECO NUMERIC(10,2) NOT NULL,
           PRECO_NOVO NUMERIC(10,2) NOT NULL,
           DATA DATETIME,
           USUARIO VARCHAR(30),
           OBS VARCHAR(50)
)
GO

INSERT INTO PRODUTOS VALUES('Pote de Geleia','Comida',13.00)
INSERT INTO PRODUTOS VALUES('A Mão Misteriosa','Livros',50.00)
INSERT INTO PRODUTOS VALUES('Carne de Boi 2kg','Açougue',42.00)
INSERT INTO PRODUTOS VALUES('Iphone X12','Tecnologia',4200.00)
INSERT INTO PRODUTOS VALUES('Abacaxi','Comida',11.00)
INSERT INTO PRODUTOS VALUES('Sofá','Móvel',1200.00)
INSERT INTO PRODUTOS VALUES('Cama BOX','Móvel',1500.00)
INSERT INTO PRODUTOS VALUES('Cesta Básica','Comida',72.00)

--TRIGGER DE ATUALIZAÇÃO SOMENTE DE PREÇO--

CREATE TRIGGER ATT_PRECO --> (NOME)
ON DBO.PRODUTOS --> (DBO(TODOS OS BANCOS).(TABELA))
FOR UPDATE AS --> (DEPOIS DE UPDATE FAZER..)
IF UPDATE(PRECO) --> ( SOMENTE APOS ATUALIZAR PRECO INICAR)
BEGIN

    DECLARE @IDPRODUTO INT
    DECLARE @NOME VARCHAR(30)
    DECLARE @CATEGORIA VARCHAR(30)
    DECLARE @PRECO NUMERIC(10,2)      --> (DECLARANDO VALORES, DAS TABELAS USADAS)
    DECLARE @PRECO_NOVO NUMERIC(10,2)
    DECLARE @DATA DATETIME
    DECLARE @USUARIO VARCHAR(30)
    DECLARE @OBS VARCHAR(50)
-- VALORES VINDOS DE TABELAS SÃO INSERIDOS COM O COMANDO SELECT--
    SELECT @IDPRODUTO = IDPRODUTO FROM INSERTED
    SELECT @NOME = NOME FROM INSERTED
    SELECT @CATEGORIA = CATEGORIA FROM INSERTED
    SELECT @PRECO = PRECO FROM DELETED
    SELECT @PRECO_NOVO = PRECO FROM INSERTED
--VALORES VINDO DE FUNÇÕES SÃO ATRIBUIDOS COM O COMANDO SET--
    SET @DATA = GETDATE()
    SET @USUARIO = SUSER_NAME()
    SET @OBS = 'VALOR INSERIDO PELA TRIGGER TRG_ATT_PRODUTOS'
--INSERINDO NO HISTORICO--
    INSERT INTO HISTORICO
    (PRODUTO,CATEGORIA,PRECO,PRECO_NOVO,DATA,USUARIO,OBS)
    VALUES
    (@NOME,@CATEGORIA,@PRECO,@PRECO_NOVO,@DATA,@USUARIO,@OBS)
--MENSAGEM DE EXECUÇÃO--
    PRINT 'TRIGGER EXECUTADA COM SUCESSO'
END
GO

--VISUALIZANDO QUERY--

SELECT * FROM PRODUTOS
GO

UPDATE PRODUTOS
SET PRECO = 19.20
WHERE IDPRODUTO = 1
GO

SELECT * FROM PRODUTOS
GO

SELECT * FROM HISTORICO
GO

