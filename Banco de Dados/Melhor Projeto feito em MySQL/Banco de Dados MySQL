/* BANCO DE DADOS MySQL */

--Empresa:  REMTECH

--Objetivo: 'Abaixo'

--================================================================================================================================================================--
/* 
   1º CRIAR UM BANCO DE DADOS PARA ARMAZENAR NOSSOS DADOS DAS PLANILHAS DO EXCEL, PLANILHAS DE CADASTRO, VENDAS E DEVOLUÇÕES DE ITENS COM SEUS RESPECTIVOS PREÇOS 
E NO BANCO CRIAR UM CADASTRO DE CLIENTES. E SE POSSÍVEL COMO SÃO MUITOS DADOS CRIAR INSTRUÇÕES PARA A INSERÇÃO MAIS RÁPIDA, 
PROCEDIMENTOS PARA PUXAR OS DADOS DE PRODUTOS COMPLETOS COM INFORMAÇÕES DE CADASTRO, VENDAS E QUANTIDADE DE DEVOLUÇÕES E POR FIM CALCÚLOS PARA ÁNALISE DE DADOS.
   2º REGRAS DE NÉGOCIO, 
1- UM CLIENTE PODE TER SOMENTE UM ENDEREÇO, PODENDO OU NÃO TER NENHUM OU VÁRIOS TELEFONES DIFERENTES CADASTRADOS POR TIPOS.
2- TABELAS DE CADASTRO, VENDAS E DEVOLUÇÃO DEVEM TER ID'S DOS
PRODUTOS IGUAIS, NÃO PODENDO TER DIVERGÊNCIA.
*/
--================================================================================================================================================================--

--ORIGEM--

CREATE DATABASE REMTECH;
USE REMTECH;

--TABELAS--

CREATE TABLE CADASTRO(
           IDCADASTRO INT PRIMARY KEY AUTO_INCREMENT,
           ID_SKU CHAR(6) NOT NULL UNIQUE,
           PRODUTO VARCHAR(30) NOT NULL,
           MARCA CHAR(12) NOT NULL,
           CATEGORIA VARCHAR(30) NOT NULL,
           PRECO_UNITARIO FLOAT(10,2) NOT NULL,
           CUSTO_UNITARIO FLOAT(10,2) NOT NULL
);

CREATE TABLE VENDAS(
           IDVENDA INT PRIMARY KEY AUTO_INCREMENT,
           SKU CHAR(6) UNIQUE,
           QUANTIDADE_PEDIDOS INT NOT NULL,
           LOJA VARCHAR(30) NOT NULL,
           DATA_VENDA DATE NOT NULL,
           MARCA CHAR(12),
           ID_CLIENTE INT,
           PRECO_UNITARIO FLOAT(10,2),
           CUSTO_UNITARIO FLOAT(10,2)
);

CREATE TABLE DEVOLUCOES(
           IDDEVOLUCAO INT PRIMARY KEY AUTO_INCREMENT,
           SKU CHAR(6) UNIQUE,
           QUANTIDADE_PEDIDOS INT,
           LOJA VARCHAR(30),
           DATA_DEVOLUCAO DATE NOT NULL
);

CREATE TABLE CLIENTE(
           IDCLIENTE INT PRIMARY KEY AUTO_INCREMENT,
           NOME VARCHAR(40) NOT NULL,
           SEXO ENUM('MASCULINO','FEMININO','OUTROS') NOT NULL,
           NASCIMENTO DATE
);

CREATE TABLE ENDERECO(
           IDENDERECO INT PRIMARY KEY AUTO_INCREMENT, 
           RUA VARCHAR(30) NOT NULL,
           BAIRRO VARCHAR(30) NOT NULL,
           CIDADE VARCHAR(30) NOT NULL,
           ESTADO CHAR(2) NOT NULL,
           ID_CLIENTE INT UNIQUE
);

CREATE TABLE TELEFONE(
           IDTELEFONE INT PRIMARY KEY AUTO_INCREMENT, 
           TIPO ENUM('COM','RES','CEL') NOT NULL,
           TELEFONE INT(15) NOT NULL,
           ID_CLIENTE INT
); 

--CONSTRAINTS(REGRAS DE NÉGOCIO)--

--VENDAS--

ALTER TABLE VENDAS
ADD CONSTRAINT FK_SKU_CADASTRO
FOREIGN KEY(SKU)
REFERENCES CADASTRO(ID_SKU);

ALTER TABLE VENDAS
ADD CONSTRAINT FK_MARCA_CADASTRO
FOREIGN KEY(MARCA)
REFERENCES CADASTRO(MARCA);

ALTER TABLE VENDAS
ADD CONSTRAINT FK_ID_CLIENTE_CLIENTE
FOREIGN KEY(ID_CLIENTE)
REFERENCES CLIENTE(IDCLIENTE);

ALTER TABLE VENDAS
ADD CONSTRAINT FK_PRECO_UNITARIO_CADASTRO
FOREIGN KEY(PRECO_UNITARIO)
REFERENCES CADASTRO(PRECO_UNITARIO);

ALTER TABLE VENDAS
ADD CONSTRAINT FK_CUSTO_UNITARIO_CADASTRO
FOREIGN KEY(CUSTO_UNITARIO)
REFERENCES CADASTRO(CUSTO_UNITARIO);

--DEVOLUCAO--

ALTER TABLE DEVOLUCOES
ADD CONSTRAINT FK_SKU_CADASTRO
FOREIGN KEY(SKU)
REFERENCES CADASTRO(ID_SKU);

ALTER TABLE DEVOLUCOES
ADD CONSTRAINT FK_LOJA_VENDAS
FOREIGN KEY(LOJA)
REFERENCES VENDAS(LOJA);

--ENDERECO E TELEFONE--

ALTER TABLE ENDERECO
ADD CONSTRAINT FK_ID_CLIENTE_CLIENTE
FOREIGN KEY(ID_CLIENTE)
REFERENCES CLIENTE(IDCLIENTE);

ALTER TABLE TELEFONE
ADD CONSTRAINT FK_ID_CLIENTE_CLIENTE
FOREIGN KEY(ID_CLIENTE)
REFERENCES CLIENTE(IDCLIENTE);

--PROGRAMANDO PROCEDIMENTOS DE INSERÇÃO RÁPIDA--

DELIMITER //

CREATE PROCEDURE INSERT_VENDA(@SKU CHAR(6), @QUANTIDADE_PEDIDOS INT, 
                           @LOJA VARCHAR(30), @DATA_VENDA DATE,
                           @MARCA CHAR(12), @REFENCIA_CLIENTE INT,
                           @PRECO_UNITARIO FLOAT(10,2),
                           @CUSTO_UNITARIO FLOAT(10,2))
BEGIN
          INSERT INTO VENDAS VALUES
          (NULL, @SKU, @QUANTIDADE_PEDIDOS, @LOJA, @DATA_VENDA,
           @MARCA, @REFENCIA_CLIENTE, @PRECO_UNITARIO, @CUSTO_UNITARIO);
END
//

CREATE PROCEDURE INSERT_DEVOLUCAO(@SKU CHAR(6), @QUANTIDADE_PEDIDOS INT, @LOJA VARCHAR(30), @DATA_DEVOLUCAO DATE)
BEGIN
          INSERT INTO DEVOLUCOES VALUES
          (NULL, @SKU, @QUANTIDADE_PEDIDOS, @LOJA, @DATA_DEVOLUCAO);
                       
END
//

CREATE PROCEDURE RESUMO_SKU(@SKU CHAR(6))
BEGIN
       SELECT C.ID_SKU AS ID, C.PRODUTO, C.MARCA, C.CATEGORIA, 
       C.PRECO_UNITARIO, C.CUSTO_UNITARIO, V.QUANTIDADE_PEDIDOS,
       V.LOJA, D.QUANTIDADE_PEDIDOS AS "QUANTIDADE DE DEVOLUÇÕES"
       FROM CADASTRO C 
       WHERE C.ID_SKU = @SKU
       INNER JOIN VENDAS V
       ON SKU = ID_SKU
       INNER JOIN DEVOLUCOES D
       ON SKU = ID_SKU;
END
//


--ÁNALISE DE DADOS--

CREATE PROCEDURE ANALISE_PRODUTO(@SKU CHAR(6))
BEGIN
      SELECT SKU AS "ID PRODUTO",
             SUM(PRECO_UNITARIO * QUANTIDADE) AS TOTAL_VENDAS,
 AVG((SUM(PRECO_UNITARIO * QUANTIDADE)) / PRECO_UNITARIO) AS MEDIA_VENDAS,
 SUM((PRECO_UNITARIO * QUANTIDADE) - (CUSTO_UNITARIO * QUANTIDADE)) AS LUCRO 
      FROM VENDAS
      WHERE SKU = @SKU;
END
//

DELIMITER ;

/* COMANDOS CRIADOS:

CALL INSERT_VENDA(); --> INSERIR DADOS DE VENDAS DE UM PRODUTO CADASTRADO

CALL INSERT_DEVOLUCAO(); --> INSERIR DADOS DE DEVOLUÇÃO DE UM PRODUTO CADASTRADO.

CALL RESUMO_SKU(); --> RESUMO DE PEDIDO, QUANTIDADE VENDIDA, DEVOLVIDA E ETC.
                       SUPORTA 1 ID.

CALL ANALISE_PRODUTO(); --> ÁNALISE DE TOTAL, MÉDIA E LUCRO DE VENDA POR PRODUTO
                            ESPÉCIFICADO. SUPORTA 1 ID.

*/

/* MISSÃO EXTRA:
   CRIAR UM PROCEDIMENTO PARA VER TODOS OS DADOS DE CLIENTES, E
   PARA SOMENTE UM CLIENTE ESPECÍFICO TAMBÉM
*/

--RESUMO DE TODOS OS CLIENTES--

CREATE VIEW RESUMO_CLIENTES AS

      SELECT C.IDCLIENTE, C.NOME, C.SEXO AS GÊNERO, 
             (DATE_FORMAT(C.NASCIMENTO,'%d/%m/%Y')) AS NASCIMENTO,
             E.RUA, E.BAIRRO, E.CIDADE, E.ESTADO, T.TIPO, T.TELEFONE
      FROM CLIENTE C
      INNER JOIN ENDERECO E 
      ON ID_CLIENTE = IDCLIENTE
      INNER JOIN TELEFONE T
      ON ID_CLIENTE = IDCLIENTE;

DELIMITER //

CREATE PROCEDURE RESUMO_CLIENTE(@CLIENTE_NOME VARCHAR(40))
BEGIN
       SELECT C.IDCLIENTE, C.NOME, C.SEXO AS GÊNERO, 
             (DATE_FORMAT(C.NASCIMENTO,'%d/%m/%Y')) AS NASCIMENTO,
             E.RUA, E.BAIRRO, E.CIDADE, E.ESTADO, T.TIPO, T.TELEFONE
      FROM CLIENTE C
      WHERE NOME = @CLIENTE_NOME
      INNER JOIN ENDERECO E 
      ON ID_CLIENTE = IDCLIENTE
      INNER JOIN TELEFONE T
      ON ID_CLIENTE = IDCLIENTE;

END
//

--COMANDOS CRIADO DE BUSCA DE UM CLIENTES, E 
--VIEW COM BUSCA DE TODOS OS CLIENTES(CUIDADO! GRANDES VOLUMES USE A FUNCÃO LIMIT)

SELECT * FROM RESUMO_CLIENTES
LIMIT 25;

CALL RESUMO_CLIENTE(); --> FILTRAR TODOS OS DADOS DE UM ÚNICO CLIENTE

/*
    AGORA QUE CRIAMOS O BANCO DE DADOS, TABELAS, REGRAS, INSTRUÇÕES E VIEWS
    IREMOS INSERIR OS DADOS.

    NESSE CASO DA REMTECH IREMOS MIGRAR OS DADOS DE TABELAS DE EXCEL PARA O BANCO,
    ENTÃO EM VEZ DE INSERIR NA MÃO, USAREMOS A FUNÇÃO DE IMPORTAÇÃO CSV(CLARO QUE ANTES DEVEMOS TRANSFORMAR O ARQUIVO EXCEL .XLMS EM .CSV)
*/

--PRIMEIRO DE TUDO, CAMINHO DE IMPORTAÇÃO DE ARQUIVOS DO MYSQL É UM DIRÉTORIO ESPECÍFICO QUE PODE SER ACHADO COM ESSE SIMPLES COMANDO:

SHOW VARIABLES LIKE "secure_file_priv";

--DEPOIS DE SABER O CAMINHO COLOQUE O ARQUIVO, E USE ESSE COMANDO DE IMPORTAÇÃO:

/*

MODELO PARA ENTENDER:

LOAD DATA INFILE'CAMINHO(DETALHE AS BARRAS EM PADRÃO(\) DEVEM SER MUDADAS PARA (/)' 
INTO TABLE TABELA_IMPORTAÇÃO(NO NOSSO CASO = CADASTRO) 
FIELDS TERMINATED BY '(DELIMITADOR, NESTE CASO ',')' 
ENCLOSED BY '"'(PADRÃO) 
LINES TERMINATED BY '\n(PADRÃO, LER ATÉ A ÚLTIMA LINHA)' 
IGNORE 1 ROWS( CASO TENHA CABEÇALHO, QUE NO NOSSO CASO TEM);

*/

--IMPORTAÇÃO--

LOAD DATA INFILE 'C:/ProgramData/MySQL/MySQL Server 8.0/Uploads/PlanilhaTeste.csv'
INTO TABLE CADASTRO
FIELDS TERMINATED BY ','
ENCLOSED BY '"' 
LINES TERMINATED BY '\n'
IGNORE 1 ROWS;

--FEITO ISSO OS CADASTROS ESTÃO FEITOS, DEPOIS REALIZE NA PLANILHA DE VENDAS E DEVOLUÇÃO--


--=========================================================--
--OBRIGADO POR VER ATÉ AQUI :)
--SE TIVER ALGUMA SUGESTÃO E FEEDBACK ENTRE EM CONTATO ;)
--=========================================================--
 



